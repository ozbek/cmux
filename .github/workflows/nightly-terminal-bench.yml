name: Nightly Terminal-Bench

on:
  schedule:
    # Run full benchmark suite every night at midnight UTC
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      models:
        description: 'Models to test (comma-separated, or "all" for both)'
        required: false
        default: "all"
        type: string
      experiments:
        description: "Experiments to enable (comma-separated)"
        required: false
        type: string

jobs:
  # Smoke test: run chess-best-move task first to catch broken agent setup
  # If this fails, skip the full suite to save time and API costs
  smoke-test:
    name: Smoke test (chess-best-move)
    uses: ./.github/workflows/terminal-bench.yml
    with:
      model_name: "anthropic/claude-sonnet-4-5"
      thinking_level: "high"
      dataset: "terminal-bench@2.0"
      concurrency: "1"
      task_names: "chess-best-move"
      experiments: ${{ inputs.experiments }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DAYTONA_API_KEY: ${{ secrets.DAYTONA_API_KEY }}

  determine-models:
    name: Determine models to test
    needs: smoke-test
    runs-on: ubuntu-latest
    outputs:
      models: ${{ steps.set-models.outputs.models }}
    steps:
      - name: Set models matrix
        id: set-models
        env:
          INPUT_MODELS: ${{ inputs.models }}
        run: |
          if [ "$INPUT_MODELS" = "all" ] || [ -z "$INPUT_MODELS" ]; then
            echo 'models=["anthropic/claude-opus-4-5","openai/gpt-5.2-codex"]' >> "$GITHUB_OUTPUT"
          else
            # Convert comma-separated to JSON array
            models_json=$(echo "$INPUT_MODELS" | jq -R -s -c 'split(",") | map(gsub("^\\s+|\\s+$"; ""))')
            echo "models=$models_json" >> "$GITHUB_OUTPUT"
          fi

  benchmark:
    name: ${{ matrix.model }}
    needs: [smoke-test, determine-models]
    strategy:
      matrix:
        model: ${{ fromJSON(needs.determine-models.outputs.models) }}
      fail-fast: false
      max-parallel: 1  # Run models sequentially to stay within Daytona's 25-sandbox limit
    uses: ./.github/workflows/terminal-bench.yml
    with:
      model_name: ${{ matrix.model }}
      thinking_level: "high"
      dataset: "terminal-bench@2.0"
      concurrency: "48"
      env: "daytona"
      experiments: ${{ inputs.experiments }}
    secrets:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DAYTONA_API_KEY: ${{ secrets.DAYTONA_API_KEY }}
