name: "Setup Mux"
description: "Setup Bun and install dependencies with caching"
inputs:
  skip-build-caches:
    description: "Skip Electron and electron-builder caches (for test-only jobs)"
    required: false
    default: "false"
runs:
  using: "composite"
  steps:
    - name: Setup Bun
      uses: oven-sh/setup-bun@b7a1c7ccf290d58743029c4f6903da283811b979 # v2.1.0
      with:
        bun-version: 1.3.5

    - name: Get Bun version
      id: bun-version
      shell: bash
      run: echo "version=$(bun --version)" >> $GITHUB_OUTPUT

    - name: Cache node_modules
      id: cache-node-modules
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: node_modules
        key: ${{ runner.os }}-${{ runner.arch }}-bun-${{ steps.bun-version.outputs.version }}-node-modules-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-bun-${{ steps.bun-version.outputs.version }}-node-modules-

    - name: Check if node_modules exists
      id: check-node-modules
      shell: bash
      run: |
        if [ -d "node_modules" ] && [ -d "node_modules/.bin" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    # Only restore bun install cache when node_modules is completely missing.
    # This avoids 88+ seconds of tar/zstd decompression on Windows for partial cache hits.
    - name: Cache bun install cache
      if: steps.check-node-modules.outputs.exists != 'true'
      id: cache-bun-install
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: ~/.bun/install/cache
        key: ${{ runner.os }}-bun-cache-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-bun-cache-

    # Always run install if we didn't get an exact cache hit.
    # This handles restore-key matches which may have stale/incomplete node_modules.
    # Delete node_modules first to ensure a clean install - bun install --frozen-lockfile
    # only verifies packages are present, it doesn't update stale packages from a restore-key match.
    - name: Install dependencies
      if: steps.cache-node-modules.outputs.cache-hit != 'true'
      shell: bash
      run: |
        rm -rf node_modules
        bun install --frozen-lockfile

    # Cache Electron binaries and electron-builder resources (NSIS, etc.)
    # These are downloaded during electron-builder and can be 200MB+ total.
    # Skip for test-only jobs to save ~30s on Windows (260MB + 11MB cache restore).
    - name: Cache Electron
      if: ${{ inputs.skip-build-caches != 'true' }}
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: |
          ~/.cache/electron
          ~/Library/Caches/electron
          ~/AppData/Local/electron/Cache
        key: ${{ runner.os }}-${{ runner.arch }}-electron-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-electron-

    - name: Cache electron-builder
      if: ${{ inputs.skip-build-caches != 'true' }}
      uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
      with:
        path: |
          ~/.cache/electron-builder
          ~/Library/Caches/electron-builder
          ~/AppData/Local/electron-builder/Cache
        key: ${{ runner.os }}-${{ runner.arch }}-electron-builder-${{ hashFiles('**/bun.lock') }}
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-electron-builder-
